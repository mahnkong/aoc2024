use strict;
use Data::Dumper;

my $rules = {
    'N' => {
        move => sub ($$) {
            my $i = shift;
            my $j = shift;
            return $i-1,$j;
        },
        next => 'E',

    },
    'S' => {
        move => sub ($$) {
            my $i = shift;
            my $j = shift;
            return ($i+1,$j);
        },
        next => 'W'
    },
    'W' => {
        move => sub ($$) {
            my $i = shift;
            my $j = shift;
            return ($i,$j-1);
        },
        next => 'N'
    },
    'E' => {
        move => sub ($$) {
            my $i = shift;
            my $j = shift;
            return ($i,$j+1);
        },
        next => 'S'
    }
};

my $first_direction;
my $first_coordinates = [undef, undef];
my $map = [];

my $max_i = 0;
my $max_j = 0;

my $i = 0;
foreach my $line (<DATA>) {
    chomp $line;
    my $j = 0;
    $map->[$i] = [];
    foreach my $p (split //, $line) {
        if ($p eq '^') {
            $first_direction = 'N';
            $first_coordinates = [$i, $j];
        }
        $map->[$i]->[$j] = $p;
        $j += 1;
    }
    $i += 1;
    $max_j = $j-1 unless $max_j;
}
$max_i = $i-1;

my $current_coordinates = [];
my $current_direction = $first_direction;
($current_coordinates->[0], $current_coordinates->[1]) = ($first_coordinates->[0], $first_coordinates->[1]);
my %passed;

do {
    ($current_coordinates, $current_direction) = navigate_next($current_coordinates, $current_direction, \%passed, 0);
    print $current_direction."\n";
} while (cordinates_valid($current_coordinates));

my $obstacles = 0;
foreach my $obstacle (keys %passed) {
    my ($oi, $oj) = split /X/, $obstacle;
    if ($map->[$oi]->[$oj] ne "^") {
        print "Testing $obstacle\n";
        $map->[$oi]->[$oj] = "#";

        my %visits;
        my $current_coordinates = [];
        ($current_coordinates->[0], $current_coordinates->[1]) = ($first_coordinates->[0], $first_coordinates->[1]);
        my $current_direction = $first_direction;
        my $abort = 0;
        do {
            if (exists($visits{$current_coordinates->[0] ."X" . $current_coordinates->[1]."X".$current_direction})) {
                $obstacles += 1;
                $abort = 1;
            } else {
                ($current_coordinates, $current_direction) = navigate_next($current_coordinates, $current_direction, \%visits, 1);
            }
        } while (cordinates_valid($current_coordinates) && !$abort);
        $map->[$oi]->[$oj] = ".";
    }
}

print "Possible obstacles: $obstacles\n";

sub navigate_next($$$$) {
    my $coordinates = shift;
    my $direction = shift;
    my $visits_ref = shift;
    my $store_direction = shift;

    if ($store_direction) {
        add_visits($coordinates, $visits_ref, $direction);
    } else {
        add_visits($coordinates, $visits_ref, undef);
    }
    my ($next_i, $next_j) = $rules->{$direction}->{move}->($coordinates->[0], $coordinates->[1]);
    if ($map->[$next_i]->[$next_j] eq "#") {
        $direction = $rules->{$direction}->{next};
    }
    
    my $new = [];
    @$new = $rules->{$direction}->{move}->($coordinates->[0], $coordinates->[1]);
    if ($map->[$new->[0]]->[$new->[1]] ne "#") {
        $coordinates = $new;
    }
    return ($coordinates, $direction);
}

sub add_visits($$$) {
    my $coords = shift;
    my $visits = shift;
    my $direction = shift;

    if ($direction) {
        $visits->{$coords->[0] ."X" . $coords->[1]."X".$direction} = undef;
    } else {
        $visits->{$coords->[0] ."X" . $coords->[1]} = undef;
    }
}


sub cordinates_valid($) {
    my $coords = shift;

    return 0 if $coords->[0] < 0 || $coords->[0] > $max_i;
    return 0 if $coords->[1] < 0 || $coords->[1] > $max_j;
    return 1;
}


__DATA__
......#...........#..............................#..............................#...........................##...............#....
.............#..............#........#......##...................................................#............##...#..........#...
...#..................#..............#.........#...#.........................................................................#..#.
.....#..........#...................#.....................#..........#...........#......#..#...................#..................
...#...............................................##..................#............#.....#...................#...................
.#.#..#...................#.##.................#..........#................................#......#.........##..................#.
....................#...................#....#.........#....................#....................................................#
..........#......#...................................................................................................#....#.......
.#...............#.........#...........#...............#...................#......#...............................................
............#...........#........#..##.......#........#.....#................................##...................................
...................#.#.............###.................##.................#.......................#.....#..............##.........
.........................#...#............................#......#.......................#........................................
.....................#..............................................#.......#......##......................................#......
............................#.#............................................................................#.................#....
.#.....#.......................................................#..........#.......................................................
..............#..............................#.....#....#........#....................#....#.#...........#.#..................#...
........................#...#...##......#...........................#.............#............................#..................
...#........................................................#...#...........................#...#...............#........#........
.........#..#..........#.....................................#..................................................................#.
...........................................#.........#....#........................................#..#...........#...............
..#..........#...........................................................................................#..............#.........
...#.......#......................................#...............#...............................................................
.#........#......#.#....................................#...#...........#..........#........#.#.......#.......................#...
......................#...........#......##....................#..................#......#..............................#.......#.
..............#......................#..............#...#.#............................................................#.#........
..............#..................#...#..................#...#.....#...#...............#...........................................
.............#............................##..#...#...............................................................##..............
..#............................#.......#.#....................................#...................................................
.......#.....#..........#......#.....#...................................#...........................#......#....#..............#.
.#.................#.............................................#................#.............#.....#....................#......
..............#.........#..#.....#...........#..............................#.................................#............#......
....#.#............#............................................................#..........#......................................
.........................................#.......#......#....................................#.....................#...#......#...
....#.............................#....................................#..........#................................#..............
.........#..#......#..............................................................#....................#..........................
.......................................................##...#........#......................................................#.#..#
..........................#.......##..##................................................................................#.........
..................................##..................................................................#..........................#
.#..................................................#..............#.....................#.....#..................................
.......##........................#......................................................#..........#..............................
.........#....#....#.........#.#........................#...#.....................................................#.....#.........
....#.............................#....#....................#.....................#.....#......#.....................#..........#.
............................................................................................#..........#......#...................
..................................................................................#..........................#.#.....#.........#..
..................................................#...................................................#......#.....#............#.
..........................................^#................................................................................#.....
...............#..........#.............................................#.....#....#...................#................#.........
#..#....#........#........#.........#.......#.................#.......................#.#.............#...................#.......
..#................................................................#......................................#.......................
........#......................#.....................##.#..........#.............................#.............................#..
....#..........#........................#.........................................................................................
......#...#.#.#.........#.................#.....#.....#...#......#..................................................##........#...
...#....#....................#...................................................................#......#...............#.........
..#.......#.........................#..........#........#............................#......#....................#................
.................................#.......................................#....................................................#..#
......................#...#........................#.......................#.............#........................................
......#.......#...................................................................................................#...............
.............#............#......#............................#...........................................##......................
..........................#.....................................................................................#.................
....#..............................#......................#........................................#....#...........#.............
................#.......#.........................................................................................................
.............#............#........#.....#.........#.#.#............................#..........#..............#....#.......#.....#
..#.....#...............................................................................................#...............#.........
.......#...........#............#................#.......................................#..........................#......#......
..........#........................................#......................#............#....................................#..#..
.......#......#..............................#........................................................#.#.................#.......
.#.................#..#.....................................................................................#...........##........
#...................................#........................................#..............#.##........#..#.#.............#......
......#...............#........#....#.........#.........#...#.......................#...........................#............#....
...#...................................................................................#.......................................#..
.....#.......................................#................#...............................................................#...
.#................................................##................................#....................#...............#........
.................................................#..#..................#.......#........................#...............#.....#...
.....##.#.............................#.....................#................................................................#...#
...........#....................#...........#...............#.................................................#.......#.......#..#
........#....................................................#.....#....#.........................................#.....#.#.......
...............#..........................#............#.#.................................................#......................
...........#......#.....................#...................................................................#.#..............#....
......#...#.........................#..........................................................#..................................
.....................#................................................#..#........................................................
..............#.................#............#....................#.#.......................................#............#........
............#.....................#................#......#..........................#.#.........#............#...................
........................................................................#.....................#...................................
.............................#....................................................................................................
.........................#...#..........................................#............................................#............
..#...............................#.....#.....#.............#.......#..#.................##.#.......................#.........#.#.
......................................#...........................................................................................
...........#.....................................#................#...#.........................#........................#........
..#...#..#..........................#.......#....#......................................................#................#........
.....................................#...#.#........#...............#..#......#.....................................#...#.........
.#..............#..............................................................#.........................##......................#
..........#..................................#....#.........#...#.#..........#...#...................................##...........
...............#.....................................................................................................#............
.#.......#....................#...#..........................#.#...............#......................#........#.................#
.............#....................#........................#..................#......#....#....#..................................
........#..............................................................#.....................#....................................
.......................#..............#.............#......#.........................................#.........................#..
.......#.......#.#........#.......................#..#.......................................................#.#..................
...............#..#....#.......................#.....#..............................#..................#.....................#....
......#..............#...........................#............................##...........................#......................
.......................................#........#................................#..........................#.....................
.#.....................................#............#.............................................................#..#............
..................#..................#.........................#............#..........#.........................#...#............
.......................................................#..............#..........................................................#
...#....#..#...#..#...................##....................#.....................#...................#.....#..........#..........
.......................#........#....................##.................#.......................................................#.
........#.......#.......................#.#......##...##........#..##.........................................#...............##..
....#..........................#.........##..#......#...........................#........#........#...#...........................
...#..........................#.....#.....................................#.......................................................
....................................##.......#..............................#.............#...#......#.............#..............
.#..............................#...............................................................................................#.
.....#................................................................................##.....#..............#.#...................
...........................................................................................#....#................#................
...#..#...................................................#....#.......#.......#.................................#........#.......
.#....#....................#..............................................................................#.............#.......#.
.........#.................#.......................................#...........#......#.......#............#............#.........
........................................#...............................#.........................................................
..............#....#......................#..........#........#.....................................#...........#..........#......
......##....#.............#..........#......................#.........................................##..........................
....................#.............................#.....................##.#..........#..#......................###.........#.....
.#.......................................##........................#.....#.....#..#...............................................
..............................#............................#.......................................................##.............
.........#.............................#..............#......#.....#..............#.#............................#........#....#..
............#..............#.............................#..........................#.............................#...............
.................#...........#..............#.....#..............................#.............#................#.....#...........
........#.....................#........#.....................................#..........................#......#.#................
.....................................................#..#........................#.##..#.........#................................
......#..............................................#..........................#...............................#..........#......
.................................................#.................##.......................#...................................#.
....................#.....#.......#.............#................................#..........#...#.................................
